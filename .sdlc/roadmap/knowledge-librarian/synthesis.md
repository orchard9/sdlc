# Knowledge Librarian: Core Design Decisions

## What the librarian IS

A project-generated Claude agent that serves as the active custodian of the knowledge base.
Not generic — generated by `sdlc knowledge librarian init` with the project's catalog and
domain context baked in. The librarian is the knowledge system's only writer with autonomous
authority (git is the undo button).

## Two modes

**Maintain mode** (scheduled + hooks)
- Runs weekly (cron/hook) and on workspace-completion hooks
- Checks URL sources for 404s
- Scans for code references that no longer exist
- Detects near-duplicate entries
- Proposes new catalog categories when knowledge clusters emerge
- Merges thin/redundant catalog sections
- Flags entries not touched in 90+ days for freshness review
- Harvests insights from completed investigations (root-cause/evolve/guideline)

**Query mode** (on-demand)
- Answers natural-language questions across all knowledge entries
- Synthesizes from multiple entries, cites which ones it drew from
- When a question hits a gap → initiates a research run to fill it
- Entry point: `sdlc knowledge ask "<question>"`

## New fields on KnowledgeEntry

```yaml
last_verified_at: "2026-03-01T..."
staleness_flags: []          # url_404 | code_ref_gone | superseded_by | aged_out
origin: manual | web | research | harvested
harvested_from: "root-cause/auth-bug"  # workspace slug if harvested
```

## Catalog: emergent, not designed

Default catalog is sparse (5–7 categories). The librarian proposes new categories
as knowledge accumulates. The initial catalog is generated from the project's own
domain signals (VISION.md, ARCHITECTURE.md, code scan) — not from a generic template.

## Harvest hook (solves the maintenance death spiral)

When any investigation reaches `done`, a post-complete hook fires:
  `sdlc knowledge librarian harvest <investigation-slug>`

The librarian reads all sessions and artifacts from the completed workspace,
extracts durable insights, and writes or updates knowledge entries. Maintenance
is structurally forced — not volunteered.

## Generation: `sdlc knowledge librarian init`

1. Scans project (VISION.md, ARCHITECTURE.md, code, .sdlc/ state)
2. Derives sparse initial catalog from project's actual domains
3. Writes `.claude/agents/librarian.md` with catalog + project context injected
4. Registers weekly maintenance hook
5. Registers workspace-completion harvest hook

## CLI additions

```bash
sdlc knowledge librarian init          # generate project-specific librarian agent
sdlc knowledge librarian run           # run maintenance pass manually
sdlc knowledge librarian harvest <slug>  # extract insights from completed workspace
sdlc knowledge ask "<question>"        # query the knowledge base in natural language
```

## Open questions

1. Query mode: CLI command vs. chat UI panel (like InvestigationDialoguePanel)?
   Both have value — CLI for mid-flow lookups, UI for exploratory queries.

2. Write authority: full autonomous writes vs. propose-and-review?
   Project ethos says autonomous — git is the undo button.

3. Team knowledge vs. project knowledge: the librarian is codebase-level (shared),
   not per-developer. All devs benefit from the same maintained knowledge base.
